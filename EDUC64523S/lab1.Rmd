---
title: "Week 8 Lab"
author: "(add your name)"
date: "5/23/2023 and 5/24/2023"
output: 
 html_document:
     code_folding: hide
---

```{r setup, include=FALSE}
# Don't make any change here
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

Instruction to work on this sheet: 

 - In each code chunk, you can find some code being taken out purposefully and left with three dots instead
 - Your task is to first **uncomment the code line**, then **replace the three dots with the code you would write**

### Today's topic: clustered data modeling

Refer to the [lecture slides](https://uo-educ-quant.github.io/645/slides/EDUC645_nested_data_Sp23.html#1) and [textbook chapter](https://bookdown.org/roback/bookdown-BeyondMLR/ch-multilevelintro.html) to refresh your content knowledge. 

### Data 

```{r}
pacman::p_load(tidyverse, dplyr, lme4, performance, lmerTest, gtsummary, modelsummary)
```


```{r}
df0 <- read.csv("https://github.com/claireconglizhang/my-slides/EDUC64523S/popular.csv") %>% 
  select(class, extrav, sex, texp, popteach)
head(df0)
```

Data management:
 - Check if all variables have the right class
    - pupil, class, sex, should be nominal (factor) rather than continuous (double)
 - Check if there's any missing value
 - Produce a summary stats table

```{r}
df <- df0 %>% 
  mutate_at(c("pupil", "class", "sex"), as.factor)
```


**Table 1. Analytic sample summary statistics**

```{r}
set_gtsummary_theme(list(
  `tbl_summary-fn:percent_fun` = function(x) sprintf("%.2f", x * 100)
))

df %>%
  select(popteach, extrav, sex, texp) %>% 
  tbl_summary(
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{p}%"),
    label = list(popteach ~ "Popularity (rated by teacher)",
                 extrav ~ "Extraversion",
                 sex ~ "Gender",
                 texp ~ "Teacher experience"))
```

**Q: report the summary stats in a sentence**

### Research question 

What is the relationship between popularity rated by teacher and level of extraversion?

Identify your variables:
 - popteach is outcome variable
 - extrav is predictor variable
 - sex and texp are covariates or potential moderators
 
### Understand data clustering:

The dataset has `r nrow(df)` students nested in `r length(unique(df$class))` classes.

**Figure 1. Visualization of the bivariate relationship**

```{r}
ggplot(df,
       aes(x = extrav, y = popteach)) +
  geom_smooth(method = 'lm', se = F) +
  labs(x = "Extraversion",
       y = "Popularity (rated by teacher)") +
  theme_minimal(base_size = 14) 
```


**Figure 2. Visualization of the bivariate relationship within each class (first six classes)**

```{r}
df %>% 
  filter(class %in% c("1", "2", "3", "4", "5", "6")) %>% 
  ggplot(aes(x = extrav, y = popteach, color = class)) +
  geom_smooth(method = 'lm', se = F) +
  labs(x = "Extraversion",
       y = "Popularity (rated by teacher)",
       color = "Class") +
  theme_minimal(base_size = 14) 
```
**Q: compare the two plots in a sentence to illustrate the clustering nature of the data**

### Unconditional model and ICC

Fit an unconditional model.

```{r}
m0 <- lmer(popteach ~ 1 + (1 | class), df)
coef(summary(m0))
```

Calculate the ICC to explain how much variance in 'popteach' is attributable to between-class variation

```{r}
performance::icc(m0)
```
**Q: interpret the ICC in a sentence**

### Modeling the relationship ("sex" and "texp" as covariates) 

Fixed-effects model:

```{r}
m1 <- lm(popteach ~ extrav + sex + texp, df)
coef(summary(m1))
```

Random-intercepts model:

```{r}
m2 <- lmer(popteach ~ extrav + sex + texp + (1 | class), df)
coef(summary(m2))
```

Random-effects model (allow both intercepts and slopes to vary by "class"):

```{r}
m3 <- lmer(popteach ~ extrav + sex + texp + (extrav | class), df)
coef(summary(m3))
```
**Q: interpret each model in a sentence, focus on only the fixed effect, the coeffcient of interest (coefficient on "extrav").**

### Compare model fitting

Compare the model fitting of random-intercepts model and the random-effects model 

```{r}
performance::compare_performance(m2, m3, metrics = "common") %>% 
  print_md()
```

**Q: Compare the two models in a sentence.**

Test whether there is a significant difference in fit between models with and without random slopes:

```{r}
lmerTest::ranova(m3)
```

### Testing interaction effects

"sex" as moderator:

```{r}
m4 <- lmer(popteach ~ extrav + sex + texp + sex:extrav + (extrav | class), df)

coef(summary(m4))
```

"texp" as moderator:

```{r}
m5 <- lmer(popteach ~ extrav + sex + texp + texp:extrav + (extrav | class), df)
coef(summary(m5))
```

**Q: are there significant interaction effects?**

### Test assumptions

Let's select the random-effects model with "extrav" and "texp" interaction.

Residual normality:

```{r}
plot(check_normality(m5), type = "qq")
```

Multicollinearity:

```{r}
plot(check_collinearity(m5))
```

Influential outliers:

```{r}
plot(check_outliers(m5))
```

**Q: in a sentence, discuss whether the critical assumptions were violated.**

### Interpreting interaction

Using 2, 10, 25 as prototypical values of "texp" to see, for teachers with different experience level, how the 

```{r}
library(ggeffects)
predicted <- ggpredict(m5,
                       type = "re",
                       terms = c("extrav", "texp [2, 10, 25]"))
predicted
```


```{r}
plot(predicted)
```

**In a sentence, interpret how the relationships between teacher rated popularity and extraversion differ by teacher experience.**

